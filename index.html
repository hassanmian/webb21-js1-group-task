<!DOCTYPE html>

<html>

<head>

</head>

<body>
    <form onsubmit="handleOnSubmit()">
        <label for="coffeeChoice">Välj kaffesort</label>
        <select id="coffeeChoice">
            <!-- <option value="0">Brygg kaffe - 20 kr</option>
            <option value="1">Cappucino - 30 kr</option>
            <option value="2">Latte - 40 kr</option> -->
        </select>
        <label for="quantity">Antal</label>
        <input id="quantity" value="1" type="number" />

        <button type="submit">Köp</button>

        <div id="totalAmount">

        </div>

        <div id="status">

        </div>
        <hr/>
        <h2>Dina transaktioner</h2>
        <div id="transactions">

        </div>

        
    </form>

    <script>
        const transactions = []

        const coffeeSelector = document.getElementById("coffeeChoice")
        const quantitySelector = document.getElementById("quantity")
        const totalAmountContainer = document.getElementById("totalAmount")
        const statusContainer = document.getElementById("status")
        const transactionContainer = document.getElementById("transactions")

        const coffees = [
            {name: 'Brygg Kaffe', price: 10, selected: false},
            {name: 'Latte', price: 45, selected: true},
            {name: 'Cappucino', price: 25, selected: false},
        ]

        function renderCoffeeChoices() {
            coffees.forEach((coffee, index) => {
                const option = document.createElement('option')
                option.value = index
                option.innerHTML = `${coffee.name} - ${coffee.price} SEK`
                option.selected = coffee.selected
                coffeeSelector.appendChild(option)
            })
        }

        function renderTransactions() {
            transactionContainer.innerHTML = ""
            transactions.forEach(transaction => {
                const transactionDiv = document.createElement('div')
                let message = `
                    Du har köpt ${transaction.name} för ${transaction.price} SEK. Totalt värde: ${transaction.total}.
                    Du var ${transaction.membership} när denna transaktion utfördes.
                `
                if(transaction.membership !== "Ultra Premium") {
                    message += `Handla ${transaction.cupsUntilNextStatus} koppar till för att uppnå ${getNextLevel(transaction.membership)}`
                }
                transactionDiv.innerText = message
                transactionContainer.prepend(transactionDiv)
            })
        }

        function getNextLevel(level) {
            if(level === "Normal") {
                return "Premium"
            } else if(level === "Premium") {
                return "Ultra Premium"
            }
        }

        function getTotalAmount() {
            let totalAmount = 0
            transactions.forEach(transaction => {
                totalAmount += transaction.total || 0
            })
            console.log(totalAmount)
            return totalAmount
        }

        function renderTotalTransactionAmount() {
            const totalAmount = getTotalAmount()
            totalAmountContainer.innerText = `Du har handlat för ${totalAmount} kr`
        }

        function getTotalCups() {
            let totalCups = 0
            transactions.forEach(transaction => {
                totalCups += parseInt(transaction.quantity)
            })
            return totalCups
        }

        function getCupsUntilNextStatus() {
            const totalCups = getTotalCups()
            if(totalCups < 5) {
                return 5 - totalCups
            } else if(totalCups >= 5 && totalCups < 15) {
                return 15 - totalCups
            } else {
                return 0
            }
        }

        function getStatus() {
            let status = ""
            const totalCups = getTotalCups()
            if(totalCups<5) {
                status = "Normal"
            } else if(5 <= totalCups && totalCups < 15) {
                status = "Premium"
            } else if(totalCups >= 15) {
                status = "Ultra Premium"
            }
            return status
        }

        function renderStatus() {
            const status = getStatus()
            statusContainer.innerText = `Medlemskapsstatus: ${status}`
        }

        function getDiscount() {
            const totalAmount = getTotalAmount()
            if(totalAmount < 1200 && totalAmount > 800) {
                return 0.95
            } else if(totalAmount >= 1200) {
                return 0.85
            }
            return 1
        }

        function handleOnSubmit() {
            event.preventDefault()
            
            const coffeeSelection = coffeeSelector.value
            const quantity = quantitySelector.value

            const chosenProduct = coffees[coffeeSelection]
            const transaction = {
                'name': chosenProduct.name,
                'quantity': quantity,
                
            }
            transactions.push(transaction)
            const latest = transactions[transactions.length - 1]
            latest.membership = getStatus()
            latest.total = quantity * chosenProduct.price * getDiscount()
            latest.price = chosenProduct.price * getDiscount(),
            latest.cupsUntilNextStatus = getCupsUntilNextStatus()
            transaction[transactions.length - 1] = latest

            renderTransactions()
            renderTotalTransactionAmount()
            renderStatus()
        }

        renderCoffeeChoices()
    </script>
</body>

</html>